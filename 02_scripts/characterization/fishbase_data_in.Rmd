---
title: "fishbase_data_in"
output: html_document
date: "2023-04-10"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(rfishbase)
library(naniar)
```

### Read in data

```{r}
data <- read_csv(here::here("01_data", "02_processed_data", "homerange_pld.csv")) %>%
  mutate(home_range = case_when(
    !is.na(observed_homerange) ~ observed_homerange,
    is.na(observed_homerange) ~ predicted_homerange
  )) %>%
  mutate(pld = case_when(
    !is.na(observed_pld) ~ observed_pld,
    is.na(observed_pld) ~ predicted_pld
  )) %>%
  filter(pld < 400) %>%
  mutate(magnitude_homerange = floor(log10(home_range))) %>%
  mutate(month_pld = ceiling(pld / 30))
```

### Rename incorect species

```{r}

data <- data %>% 
  mutate(species = str_replace(species, "Oblada melanuras", "Oblada melanurus")) %>% 
  mutate(species = str_replace(species, "Pennahia aneas", "Pennahia aneus")) 

```

### Make new clusters

```{r}

clusters <- read_csv(here::here("01_data", "02_processed_data", "clusters.csv")) %>% 
  mutate(class2 = class) %>% 
  mutate(class2 = case_when(class2 == 6 ~ 2, class2 != 6 ~ class2)) # combine classes 6 into 2
  
# split part of class 1 into 8
clusters <- within(clusters, class2[class2 == 1 & magnitude_homerange == -2] <- 8) 
clusters <- within(clusters, class2[class2 == 1 & magnitude_homerange == -3] <- 8)

# rename incorrect species
clusters <- clusters %>% 
  mutate(species = str_replace(species, "Oblada melanuras", "Oblada melanurus")) %>% 
  mutate(species = str_replace(species, "Pennahia aneas", "Pennahia aneus"))

```

### Load in taxonomic info

```{r}

fish <- load_taxa() %>%  # load all taxonomic info from fishbase into fish, then
  filter(Species %in% data$species) %>%   # select only the rows containing species listed in data
  janitor::clean_names()
  
```

### Collect diet data

```{r}

# get diet items and combine rows of the same species in each column
diet <- fooditems(fish$species, fields = c("Species", "FoodI", "FoodII", "FoodIII")) %>% 
  group_by(Species) %>% 
  summarise(FoodI = paste(sort(unique(FoodI)), collapse = ", "), 
            FoodII = paste(sort(unique(FoodII)), collapse = ", "), 
            FoodIII = paste(sort(unique(FoodIII)), collapse = ", ")) %>% 
  ungroup()

diet <- janitor::clean_names(diet)

data <- left_join(data,diet) %>% 
  select(-food_ii, -food_iii)

```

### Collect temperature data

```{r}

temp <- stocks() %>%  # load stocks info, then
  filter(SpecCode %in% fish$spec_code) %>%  # filter rows by spec codes in fish, then
  select(SpecCode, TempMin, TempMax, TempPreferred) %>% # select columns
  mutate(temp_range = TempMax - TempMin) %>% 
  arrange(SpecCode)

temp <- drop_na(temp, TempPreferred)

temp <- janitor::clean_names(temp)

#calc_mode(temp$spec_code) # find the repeated spec_code - it's 308

temp <- temp %>% 
  filter(!row_number() %in% c(106)) # remove row containing repeat

fish <- left_join(fish, temp) # this was making fish have 607 rows, removed repeat spec_code

```

### Collect climate/range data

```{r}

eco <- ecosystem() %>% 
  filter(SpecCode %in% fish$spec_code) %>% 
  select(SpecCode, Climate, NorthernLat, NrangeNS, SouthernLat, SrangeNS, 
         WesternLat, WrangeEW, EasternLat, ErangeEW) %>% 
  janitor::clean_names() %>% 
  na.omit() %>% 
  mutate(climate = tolower(climate))

eco <- eco[!duplicated(eco$spec_code), ]

fish <- left_join(fish, eco)

```

### Collect fecundity data

```{r}

fecund <- fecundity() %>%  # load stocks info, then
  filter(SpecCode %in% fish$spec_code) %>%  # filter rows by spec codes in fish, then
  select(SpecCode, FecundityMin, FecundityMax) %>%   # select columns
  janitor::clean_names() %>% 
  na.omit(fecund)

fecund <- fecund %>%  # average the values for a given spec code
  group_by(spec_code) %>% 
  summarise(fecundity_min = mean(fecundity_min), fecundity_max = mean(fecundity_max)) %>% 
  mutate(fecundity_mean = (fecundity_min + fecundity_max)/2) %>% 
  ungroup()

fish <- left_join(fish, fecund)

```

### Collect shape/age data

```{r}

spec <- species() %>%  # load stocks info, then
  filter(SpecCode %in% fish$spec_code) %>%  # filter rows by spec codes in fish, then
  select(SpecCode, BodyShapeI, LongevityWild) %>% 
  janitor::clean_names()


fish <- left_join(fish, spec)

```

### Collect metabolic data

Only 68 species with oxygen consumption data:
```{r}

oxygen <- oxygen() %>% 
  filter(SpecCode %in% fish$spec_code) %>% 
  select(SpecCode, OxygenCons, Temp) %>% 
  janitor::clean_names()

oxygen <- oxygen %>%  # average the values for a given spec code
  group_by(spec_code) %>% 
  summarise(oxygen_cons = mean(oxygen_cons), temp = mean(temp)) %>% 
  ungroup() %>% 
  rename(temp_cons = temp)

fish <- left_join(fish, oxygen)

fish <- fish %>% 
  rename(class_taxon = class)

```

### Collect reproduction data

```{r}

rep <- reproduction() %>%
  filter(SpecCode %in% fish$spec_code) %>% 
  select(SpecCode, RepGuild2, Spawning) %>% 
  janitor::clean_names()

fish <- left_join(fish, rep)


spawn <- spawning() %>% 
  filter(SpecCode %in% fish$spec_code) %>% 
  select(SpecCode, SpawningGround) %>% 
  janitor::clean_names() %>% 
  na.omit()

spawn <- spawn[!duplicated(spawn$spec_code), ]

fish <- left_join(fish, spawn)


larvae <- larvae() %>% 
  filter(SpecCode %in% fish$spec_code) %>% 
  select(SpecCode, PlaceofDevelopment) %>% 
  janitor::clean_names() %>% 
  na.omit() %>% 
  rename(dev_place = placeof_development)

larvae <- larvae[!duplicated(larvae$spec_code), ]

fish <- left_join(fish, larvae)

```

### Join new variables with data

```{r}

data <- left_join(fish, data) %>% 
  select(-spec_code, -class, -fecundity_min, -temp_max, -temp_min)

data <- full_join(data, clusters)

```

### Write new csv including added variables

```{r}

#write_csv(data, here::here("01_data", "02_processed_data", "fishbase_data.csv"))

```

### Look at missing data

```{r}

missing_data <- data %>% 
  select(oxygen_cons, temp_range, fecundity_max, 
         longevity_wild, temp_preferred, food_i, dev_place, iucn_category)
  
missing_fig <- gg_miss_var(missing_data) + # figure showing the missing data
  theme_bw()
missing_fig

#ggsave(missing_fig, file = paste0("missing_fig.png"), path = here::here("04_figs"))

```

### Fill in missing data from averages/max counts

```{r}

# replace numeric NAs with mean of genus, categorical with mode of genus

mode <- function(x) { names(which.max(table(x))) }

fish2 <- load_taxa() %>%
  filter(Genus %in% data$genus) %>%
  select(SpecCode, Genus) %>% 
  janitor::clean_names()


# Food I

missing_food <- fooditems() %>% 
  filter(SpecCode %in% fish2$spec_code) %>% 
  select(SpecCode, FoodI) %>% 
  janitor::clean_names() %>% 
  group_by(spec_code) %>%
  summarise(food_i = paste(sort(unique(food_i)), collapse = ", ")) %>% 
  ungroup()

missing_food <- left_join(fish2, missing_food)

missing_food <- missing_food %>%
  mutate(food_i = as.factor(food_i)) %>% 
  group_by(genus) %>%
  summarise(food_i = mode(food_i)) %>% 
  ungroup()

filled_data <- data 

filled_data <- filled_data %>% 
        left_join(missing_food, by = "genus") %>% 
        mutate(food_i = coalesce(food_i.x, food_i.y)) %>% 
        select(-food_i.x, -food_i.y)


# Place of Development

missing_dev <- larvae() %>% 
  filter(SpecCode %in% fish2$spec_code) %>% 
  select(SpecCode, PlaceofDevelopment) %>% 
  janitor::clean_names() %>% 
  rename(dev_place = placeof_development)

missing_dev <- left_join(fish2, missing_dev)

missing_dev <- missing_dev %>%
  mutate(dev_place = as.factor(dev_place)) %>% 
  group_by(genus) %>%
  summarise(dev_place = mode(dev_place)) %>% 
  ungroup()

filled_data <- filled_data %>% 
        left_join(missing_dev, by = "genus") %>% 
        mutate(dev_place = coalesce(dev_place.x, dev_place.y)) %>% 
        select(-dev_place.x, -dev_place.y)


# Longevity Wild

missing_long <- species() %>% 
  filter(SpecCode %in% fish2$spec_code) %>%
  select(SpecCode, LongevityWild) %>% 
  janitor::clean_names()

missing_long <- left_join(fish2, missing_long)

missing_long <- missing_long %>%
  mutate(longevity_wild = as.numeric(longevity_wild)) %>% 
  na.omit() %>% 
  group_by(genus) %>%
  summarise(longevity_wild = mean(longevity_wild)) %>% 
  ungroup()

filled_data <- filled_data %>% 
        left_join(missing_long, by = "genus") %>% 
        mutate(longevity_wild = coalesce(longevity_wild.x, longevity_wild.y)) %>% 
        select(-longevity_wild.x, -longevity_wild.y)


# Preferred Temp

missing_temp <- stocks() %>%
  filter(SpecCode %in% fish2$spec_code) %>% 
  select(SpecCode, TempPreferred) %>% 
  janitor::clean_names()

missing_temp <- left_join(fish2, missing_temp)

missing_temp <- missing_temp %>%
  mutate(temp_preferred = as.numeric(temp_preferred)) %>% 
  na.omit() %>% 
  group_by(genus) %>%
  summarise(temp_preferred = mean(temp_preferred)) %>% 
  ungroup()

filled_data <- filled_data %>% 
        left_join(missing_temp, by = "genus") %>% 
        mutate(temp_preferred = coalesce(temp_preferred.x, temp_preferred.y)) %>% 
        select(-temp_preferred.x, -temp_preferred.y)



missing <- miss_var_summary(filled_data)


# New missing plot

missing_data_filled <- filled_data %>% 
  select(oxygen_cons, temp_range, fecundity_max, 
         longevity_wild, temp_preferred, food_i, dev_place, iucn_category)
  
missing_filled_fig <- gg_miss_var(missing_data_filled) + # figure showing the missing data
  theme_bw()
missing_filled_fig

#ggsave(missing_filled_fig, file = paste0("missing_filled_fig.png"), path = here::here("04_figs"))




# ______________________ FILLED DATA 2 (includes filled oxygen_cons and temp_range)


# Oxygen Consumption

missing_ox <- oxygen() %>%
  filter(SpecCode %in% fish2$spec_code) %>% 
  select(SpecCode, OxygenCons) %>% 
  janitor::clean_names()

missing_ox <- left_join(fish2, missing_ox)

missing_ox <- missing_ox %>%
  mutate(oxygen_cons = as.numeric(oxygen_cons)) %>% 
  na.omit() %>% 
  group_by(genus) %>%
  summarise(oxygen_cons = mean(oxygen_cons)) %>% 
  ungroup()

filled_data2 <- filled_data %>% 
        left_join(missing_ox, by = "genus") %>% 
        mutate(oxygen_cons = coalesce(oxygen_cons.x, oxygen_cons.y)) %>% 
        select(-oxygen_cons.x, -oxygen_cons.y)

# 538 missing to now 430 missing


# Temp Range

missing_range <- stocks() %>%
  filter(SpecCode %in% fish2$spec_code) %>% 
  select(SpecCode, TempMin, TempMax) %>% 
  mutate(temp_range = TempMax - TempMin) %>%
  janitor::clean_names()

missing_range <- left_join(fish2, missing_range)

missing_range <- missing_range %>%
  mutate(temp_range = as.numeric(temp_range)) %>% 
  na.omit() %>% 
  group_by(genus) %>%
  summarise(temp_range = mean(temp_range)) %>% 
  ungroup()

filled_data2 <- filled_data2 %>% 
        left_join(missing_range, by = "genus") %>% 
        mutate(temp_range = coalesce(temp_range.x, temp_range.y)) %>% 
        select(-temp_range.x, -temp_range.y)

# 526 missing to now 391 missing



missing2 <- miss_var_summary(filled_data2)


# New missing plot

missing_data_filled2 <- filled_data2 %>% 
  select(oxygen_cons, temp_range, fecundity_max, 
         longevity_wild, temp_preferred, food_i, dev_place, iucn_category)
  
missing_filled2_fig <- gg_miss_var(missing_data_filled2) + # figure showing the missing data
  theme_bw()
missing_filled2_fig

#ggsave(missing_filled2_fig, file = paste0("missing_filled2_fig.png"), path = here::here("04_figs"))



```

### Write new csv including filled variables

```{r}

#write_csv(filled_data, here::here("01_data", "02_processed_data", "filled_data.csv"))

```



### Check Variable Inflation Factors (VIF) on top of collinearity

```{r}

```




### Look at any correlated data

```{r}

# for numeric variables, omit NAs?
data_cor <- data %>% 
  select(where(is.numeric)) %>% 
  select(temp_preferred, fecundity_mean, longevity_wild, length, kfin, r_fin, diet_troph3) %>% 
  na.omit()

cor_mat <- round(cor(data_cor),2) # length and weight = 0.88, age_mat_min/2 and longevity_wild > 0.70 for all three
cor_mat


```

### Plot of new clusters

```{r}

fishbase_data_gmm <- data %>% 
  mutate(class2 = as.factor(class2))

gmm_new_fig <- ggplot(fishbase_data_gmm, aes(magnitude_homerange, month_pld)) +
  geom_jitter(aes(color = class2)) +
  theme_bw() +
  labs(
    x = "Order of Magnitude of Predicted Home Range",
    y = "Predicted Pelagic Larval Duration (Month)"
  )

gmm_new_fig

# ggsave(gmm_new_fig, file = paste0("gmm_new_fig.png"), path = here::here("04_figs"), height = 8, width = 15)

```










### Old

```{r}
# IUCN Category - DO NOT IMPUTE THIS

# missing_iucn <- stocks() %>% 
#   filter(SpecCode %in% fish2$spec_code) %>% 
#   select(SpecCode, IUCN_Code) %>% 
#   janitor::clean_names() %>% 
#   mutate_at("iucn_code", str_replace, ".", "")
# 
# missing_iucn$iucn_code <- gsub("[.]","", missing_iucn$iucn_code)
# 
# 
# missing_iucn <- left_join(fish2, missing_iucn)
# 
# missing_iucn <- missing_iucn %>%
#   mutate(iucn_code = as.factor(iucn_code)) %>% 
#   group_by(genus) %>%
#   summarise(iucn_category = mode(iucn_code)) %>% 
#   ungroup()
# 
# filled_data <- filled_data %>% 
#         left_join(missing_iucn, by = "genus") %>% 
#         mutate(iucn_category = coalesce(iucn_category.x, iucn_category.y)) %>% 
#         select(-iucn_category.x, -iucn_category.y)


# # Reproduction Guild and Spawning - DO NOT NEED
# 
# missing_rep <- reproduction() %>%
#   filter(SpecCode %in% fish2$spec_code) %>% 
#   select(SpecCode, RepGuild2, Spawning) %>% 
#   janitor::clean_names()
# 
# missing_rep <- left_join(fish2, missing_rep)
# 
# 
# missing_rep <- missing_rep %>%
#   mutate(rep_guild2 = as.factor(rep_guild2), spawning = as.factor(spawning)) %>% 
#   group_by(genus) %>%
#   summarise(rep_guild2 = mode(rep_guild2), spawning = mode(spawning)) %>% 
#   ungroup()
# 
# filled_data <- filled_data %>% 
#         left_join(missing_rep, by = "genus") %>% 
#         mutate(rep_guild2 = coalesce(rep_guild2.x, rep_guild2.y), 
#                spawning = coalesce(spawning.x, spawning.y)) %>% 
#         select(-rep_guild2.x, -rep_guild2.y, -spawning.x, -spawning.y)
# 
# 
# # Spawning Ground - DO NOT NEED
# 
# missing_spawn <- spawning() %>% 
#   filter(SpecCode %in% fish2$spec_code) %>% 
#   select(SpecCode, SpawningGround) %>% 
#   janitor::clean_names()
# 
# missing_spawn <- left_join(fish2, missing_spawn)
# 
# missing_spawn <- missing_spawn %>%
#   mutate(spawning_ground = as.factor(spawning_ground)) %>% 
#   group_by(genus) %>%
#   summarise(spawning_ground = mode(spawning_ground)) %>% 
#   ungroup()
# 
# filled_data <- filled_data %>% 
#         left_join(missing_spawn, by = "genus") %>% 
#         mutate(spawning_ground = coalesce(spawning_ground.x, spawning_ground.y)) %>% 
#         select(-spawning_ground.x, -spawning_ground.y)
# 

```



```{r}
# # the package "sbha/dfnames" doesn't work with newest version of r, so here is their code (edited):
# 
# to_snake_case <- function(names){
#   x <- trimws(names)
#   x <- gsub("([a-z])([A-Z])", "\\1_\\2", x)
#   x <- gsub("[[:punct:] ]", "_", x)
#   x <- gsub("_+", "_", x)
#   x <- gsub("^_|_$", "", x)
#   #x <- make.unique(x, sep = "_")
#   x <- tolower(x)
#   x
# }
```

```{r}

# create a function to find the mode of a column

# calc_mode <- function(x){  
#   
#   distinct_values <- unique(x) # list the unique values
#   
#   distinct_tabulate <- tabulate(match(x, distinct_values)) # count the occurrence of each
#   
#   distinct_values[which.max(distinct_tabulate)] # return value with highest occurrence
# }


# not like this

# filled_data <- data %>%
#   mutate_at(vars(temp_preferred, longevity_wild, fecundity_max, fecundity_mean, 
#                  temp_range, temp_cons, oxygen_cons), 
#             ~replace_na(.,mean(., na.rm = TRUE))) %>% 
#   mutate(food_i = if_else(is.na(food_i), calc_mode(food_i), food_i)) %>%
#   mutate(iucn_category = if_else(is.na(iucn_category), calc_mode(iucn_category), iucn_category)) %>% 
#   mutate(rep_guild2 = if_else(is.na(rep_guild2), calc_mode(rep_guild2), rep_guild2)) %>%
#   mutate(spawning = if_else(is.na(spawning), calc_mode(spawning), spawning)) %>%
#   mutate(spawning_ground = if_else(is.na(spawning_ground), 
#                                    calc_mode(spawning_ground), spawning_ground)) %>%
#   mutate(dev_place = if_else(is.na(dev_place), calc_mode(dev_place), dev_place))

```


```{r}

# # get location data (lat and long)
# coords <- stocks() %>%  # load stocks info, then
#   filter(SpecCode %in% fish$SpecCode) %>%  # filter rows by specCodes in fish, then
#   select(SpecCode, Northernmost, NorthSouthN, Southermost, NorthSouthS, Westernmost,
#            WestEastW, Easternmost, WestEastE) # select columns
# 
# coords <- na.omit(coords) # remove NA values
# 
# # not sure if I need to make everything uppercase?
# 
# coords <- data.frame(lapply(coords, function(v) {
#   if (is.character(v)) return(toupper(v))
#   else return(v)
# }))
# 
# # delete duplicate spec_codes (there are only 5)
# 
# coords_clean <- coords[!duplicated(coords$SpecCode), ]
# 
# # add coords to fish because they share a column
# fish <- left_join(fish, coords_clean)

```

```{r}

# collect maturity variables

# matur <- maturity() %>% 
#   filter(SpecCode %in% fish$spec_code) %>% 
#   select(SpecCode, AgeMatMin, AgeMatMin2) %>% 
#   janitor::clean_names() %>% 
#   na.omit()
# 
# matur <- matur %>%  # average the values for a given spec code
#   group_by(spec_code) %>% 
#   summarise(age_mat_min = mean(age_mat_min), age_mat_min2 = mean(age_mat_min2)) %>% 
#   ungroup()
# 
# fish <- left_join(fish, matur)
```

```{r}
# 
# # Only 14 species with schooling behavior listed:
# 
# eco <- ecology() %>% 
#   filter(SpecCode %in% fish$spec_code) %>% 
#   select(SpecCode, SchoolingFrequency, SchoolingLifestage) %>% 
#   janitor::clean_names()

```

```{r}
# can I average the lat/long values and delete the duplicated rows? <--------------- NO. bc this messes with the E/W delineation

# mean_stocks <- stocks %>% 
  # group_by(SpecCode) %>% 
  # summarise(Northernmost = mean(Northernmost), NorthSouthN = NorthSouthN, Southernmost =
             # mean(Southermost),NorthSouthS = NorthSouthS, Westernmost = mean(Westernmost), WestEastW =
             # WestEastW, Easternmost = mean(Easternmost), WestEastE = WestEastE) %>% 
  # ungroup()
```

```{r}
# created a dataframe with 3 fewer rows?

# order(data$species) # order the dataframes by species to look for missing species names
# order(fish$Species)
# data$species[!(data$species %in% fish$Species)] # find the species in data that are not included in fish

# 3 species not included in fish: Limanda ferruginea, Oblada melanura, Pennahia anea

# Myzopsetta ferruginea for Limanda ferruginea, Oblada melanurus for Oblada melanura, Pennahia aneas for Pennahia anea
```




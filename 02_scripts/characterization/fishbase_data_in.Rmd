---
title: "fishbase_data_in"
output: html_document
date: "2023-04-10"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(rfishbase)
library(naniar)
library(car)
library(sf)
library(sp)
library(ggpubr)
library(rstatix)
library(FSA)
library(chisq.posthoc.test)
```

### Read in data

```{r}
data <- read_csv(here::here("01_data", "02_processed_data", "homerange_pld.csv")) %>%
  mutate(home_range = case_when(
    !is.na(observed_homerange) ~ observed_homerange,
    is.na(observed_homerange) ~ predicted_homerange
  )) %>%
  mutate(pld = case_when(
    !is.na(observed_pld) ~ observed_pld,
    is.na(observed_pld) ~ predicted_pld
  )) %>%
  filter(pld < 400) %>%
  mutate(magnitude_homerange = floor(log10(home_range))) %>%
  mutate(month_pld = ceiling(pld / 30))
```

### Rename incorect species

```{r}
data <- data %>%
  mutate(species = str_replace(species, "Oblada melanuras", "Oblada melanurus")) %>%
  mutate(species = str_replace(species, "Pennahia aneas", "Pennahia aneus"))
```

### Make new clusters

```{r}
clusters <- read_csv(here::here("01_data", "02_processed_data", "clusters.csv")) %>%
  mutate(class2 = class) %>%
  mutate(class2 = case_when(
    class2 == 1 ~ 3,
    TRUE ~ class2
  )) %>%
  mutate(class3 = case_when(
    class2 == 8 ~ 1,
    class2 == 9 ~ 6,
    class2 == 10 ~ 7,
    class2 == 2 ~ 2,
    class2 == 3 ~ 3,
    class2 == 4 ~ 4,
    class2 == 5 ~ 5
  )) # combine classes 1 into 3

# split part of class 1 into 8
# clusters <- within(clusters, class2[class2 == 2 & magnitude_homerange == -4] <- 8)
# clusters <- within(clusters, class2[class2 == 1 & magnitude_homerange == -3] <- 8)

clusters$class3 <- ifelse(clusters$class3 == 2 & clusters$magnitude_homerange == -4, 1, clusters$class3)

# rename incorrect species
clusters <- clusters %>%
  mutate(species = str_replace(species, "Oblada melanuras", "Oblada melanurus")) %>%
  mutate(species = str_replace(species, "Pennahia aneas", "Pennahia aneus"))

# rename classes with descriptions: homerange/PLD
clusters <- clusters %>%
  mutate(class2 = case_when(
    class2 == 1 ~ "1: low/mid-low",
    class2 == 2 ~ "2: mid-low/mid-low",
    class2 == 3 ~ "3: high/mid-low",
    class2 == 4 ~ "4: mid-high/mid-low",
    class2 == 5 ~ "5: mid/low",
    class2 == 6 ~ "6: mid/mid-high",
    class2 == 7 ~ "7: mid/high"
  ))
```

### Plot of new clusters

```{r}
data <- full_join(data, clusters)

fishbase_data_gmm <- data %>%
  mutate(class3 = as.factor(class3))

gmm_new_fig <- ggplot(fishbase_data_gmm, aes(magnitude_homerange, month_pld)) +
  geom_jitter(aes(color = class3)) +
  theme_bw(base_size = 20) +
  labs(
    x = "Order of Magnitude of Predicted Home Range",
    y = "Predicted Pelagic Larval Duration (Month)",
    color = "Class"
  )

gmm_new_fig

# ggsave(gmm_new_fig, file = paste0("gmm_fig.pdf"), path = here::here("04_figs"), height = 8, width = 15)
```

### Load in taxonomic info

```{r}
fish <- load_taxa() %>% # load all taxonomic info from fishbase into fish, then
  filter(Species %in% data$species) %>% # dplyr::select only the rows containing species listed in data
  janitor::clean_names()
```

### Get Ocean Data

```{r}
fao <- faoareas(fish$species) %>%
  janitor::clean_names() %>%
  dplyr::select(species, fao, spec_code) %>%
  filter(!grepl("Inland", fao)) %>%
  filter(!grepl("artic", fao)) %>%
  distinct() %>%
  separate(fao, into = c("ocean", "basin"), sep = ",") %>%
  group_by(species, spec_code) %>%
  summarize(
    ocean = paste(sort(unique(ocean)), collapse = ", "),
    basin = paste(sort(unique(basin)), collapse = ", ")
  ) %>%
  mutate(basin = case_when(
    (grepl("east", basin) | grepl("East", basin)) & (grepl("west", basin) | grepl("West", basin)) ~ "Both",
    (grepl("east", basin) | grepl("East", basin)) ~ "East",
    (grepl("west", basin) | grepl("West", basin)) ~ "West",
    TRUE ~ NA
  ))

fish <- left_join(fish, fao)
```

### Collect diet data

```{r}
# get diet items and combine rows of the same species in each column
diet <- fooditems(fish$species, fields = c("Species", "FoodI")) %>%
  group_by(Species) %>%
  summarise(
    FoodI = paste(sort(unique(FoodI)), collapse = ", ")
  ) %>%
  ungroup() %>%
  mutate(food_mode = case_when(
    grepl(",", FoodI) ~ "generalist",
    TRUE ~ "specialist"
  )) %>%
  janitor::clean_names()


fish <- left_join(fish, diet)
```

### Collect temperature data

```{r}
temp <- stocks() %>%
  filter(SpecCode %in% fish$spec_code) %>%
  dplyr::select(SpecCode, TempMin, TempMax, TempPreferred) %>%
  mutate(temp_range = TempMax - TempMin) %>%
  arrange(SpecCode)

temp <- drop_na(temp, TempPreferred)

temp <- janitor::clean_names(temp)

# calc_mode(temp$spec_code) # find the repeated spec_code - it's 308

temp <- temp %>%
  filter(!row_number() %in% c(106)) # remove row containing repeat

fish <- left_join(fish, temp) # this was making fish have 607 rows, removed repeat spec_code
```

### Collect climate data

```{r}
climate <- ecosystem() %>%
  filter(SpecCode %in% fish$spec_code) %>%
  dplyr::select(SpecCode, Climate) %>%
  janitor::clean_names() %>%
  mutate(climate = tolower(climate))

climate <- climate[!duplicated(climate$spec_code), ]

fish <- left_join(fish, climate)
```


### Collect fecundity data

```{r}
fecund <- fecundity() %>%
  filter(SpecCode %in% fish$spec_code) %>%
  dplyr::select(SpecCode, FecundityMax, FecundityMin, FecundityMean) %>%
  mutate(FecundityMeanCalc = (FecundityMax + FecundityMin) / 2) %>%
  filter(FecundityMeanCalc > 0) %>% # remove inconsistent data
  janitor::clean_names()

fecund <- fecund %>% # average the values for a given spec code
  dplyr::select(-fecundity_min) %>%
  group_by(spec_code) %>%
  mutate(
    fecundity_max = mean(fecundity_max, na.rm = TRUE),
    fecundity_mean = mean(fecundity_mean, na.rm = TRUE),
    fecundity_mean_calc = mean(fecundity_mean_calc, na.rm = TRUE)
  ) %>%
  mutate_at(vars(fecundity_max, fecundity_mean, fecundity_mean_calc), ~ ifelse(is.nan(.), NA, .)) %>%
  ungroup() %>%
  distinct()

fecund <- fecund %>% # combine actual mean with calculated mean
  mutate(fecundity_mean = coalesce(fecundity_mean, fecundity_mean_calc)) %>%
  dplyr::select(-fecundity_mean_calc, -fecundity_max)


fish <- left_join(fish, fecund)
```

### Collect shape/age data

```{r}
spec <- species() %>%
  filter(SpecCode %in% fish$spec_code) %>%
  dplyr::select(SpecCode, BodyShapeI, LongevityWild) %>%
  janitor::clean_names()


fish <- left_join(fish, spec)
```

### Collect metabolic data

Only 68 species with oxygen consumption data:
```{r}
oxygen <- oxygen() %>%
  filter(SpecCode %in% fish$spec_code) %>%
  dplyr::select(SpecCode, OxygenCons, Temp) %>%
  janitor::clean_names()

oxygen <- oxygen %>% # average the values for a given spec code
  group_by(spec_code) %>%
  summarise(oxygen_cons = mean(oxygen_cons), temp = mean(temp)) %>%
  ungroup() %>%
  dplyr::rename(temp_cons = temp)

fish <- left_join(fish, oxygen)

fish <- fish %>%
  dplyr::rename(class_taxon = class)
```

### Collect reproduction data

```{r}
larvae <- larvae() %>%
  filter(SpecCode %in% fish$spec_code) %>%
  dplyr::select(SpecCode, PlaceofDevelopment) %>%
  janitor::clean_names() %>%
  na.omit() %>%
  rename(dev_place = placeof_development)

larvae <- larvae[!duplicated(larvae$spec_code), ]

fish <- left_join(fish, larvae)
```

### Collect species richness by family data

```{r}
sp_rich <- load_taxa() %>%
  filter(Family %in% data$family) %>%
  dplyr::select(Family, Species) %>%
  count(Family) %>%
  dplyr::rename(family = Family, sp_richness = n)

fish <- left_join(fish, sp_rich)
```

### Collect circadian data

```{r}
# filtering for spec_codes in fish gave 86 obs, 45 had pertinent info

circ <- species() %>%
  dplyr::select(SpecCode, Comments) %>%
  filter(SpecCode %in% fish$spec_code) %>%
  filter(grepl("nocturnal|diurnal|crepuscular|day|night|daytime|nighttime|evening", Comments)) %>%
  mutate(circadian = case_when(
    SpecCode %in% c(
      646, 419, 420, 1895, 1917, 14129, 301, 401,
      69, 1494, 1844, 1407, 266, 162, 181, 1080,
      326, 188, 1747, 1342, 513, 6507, 117, 387,
      525, 1363, 5382
    ) ~ "nocturnal",
    SpecCode %in% c(
      1893, 5537, 6447, 5604, 18, 216, 227, 785,
      1265, 4228, 4826, 524, 238, 118, 4493, 458,
      1288, 372
    ) ~ "diurnal"
  )) %>%
  na.omit() %>%
  janitor::clean_names()

fish <- left_join(fish, circ) %>%
  distinct()
```

### Join new variables with data and clean names

```{r}
data <- data %>%
  filter(species %in% fish$species) %>%
  arrange(species)

fish <- fish %>%
  arrange(species) %>%
  select(-species, -family)

data <- cbind(data, fish)

data[data == "pelagic-oceanic"] <- "pelagic oceanic"
data[data == "pelagic-neritic"] <- "pelagic neritic"
data[data == "pelagic"] <- "pelagic oceanic"
```

### Write new csv including added variables

```{r}
# write_csv(data, here::here("01_data", "02_processed_data", "fishbase_data.csv"))
```

### Look at missing data

```{r}
missing <- miss_var_summary(data)

missing_data <- data %>%
  dplyr::select(
    oxygen_cons, temp_range, fecundity_mean, longevity_wild,
    temp_preferred, food_i, dev_place, iucn_category, circadian, basin
  )

missing_fig <- gg_miss_var(missing_data) + # figure showing the missing data
  theme_bw()
missing_fig

# ggsave(missing_fig, file = paste0("initial_missing_fig.png"), path = here::here("04_figs", "missing_data"))
```

### Fill in missing data from genus averages

```{r}
# replace numeric NAs with mean of genus, categorical with mode of genus

mode <- function(x) {
  names(which.max(table(x)))
}

fish_genera <- load_taxa() %>%
  filter(Genus %in% data$genus) %>%
  dplyr::select(SpecCode, Genus) %>%
  janitor::clean_names()

# Food I and Food Mode
missing_food <- fooditems() %>%
  filter(SpecCode %in% fish_genera$spec_code) %>%
  dplyr::select(SpecCode, FoodI) %>%
  janitor::clean_names() %>%
  group_by(spec_code) %>%
  summarise(food_i = paste(sort(unique(food_i)), collapse = ", ")) %>%
  ungroup()

missing_food <- left_join(fish_genera, missing_food)

missing_food <- missing_food %>%
  mutate(food_i = as.factor(food_i)) %>%
  group_by(genus) %>%
  summarise(food_i = mode(food_i)) %>%
  ungroup()

filled_data <- data

filled_data <- left_join(filled_data, missing_food) %>%
  mutate(food_mode = case_when(
    grepl(",", food_i) ~ "generalist",
    TRUE ~ "specialist"
  ))


# Place of Development
missing_dev <- larvae() %>%
  filter(SpecCode %in% fish_genera$spec_code) %>%
  dplyr::select(SpecCode, PlaceofDevelopment) %>%
  janitor::clean_names() %>%
  rename(dev_place = placeof_development)

missing_dev <- left_join(fish_genera, missing_dev)

missing_dev <- missing_dev %>%
  mutate(dev_place = as.factor(dev_place)) %>%
  group_by(genus) %>%
  summarise(dev_place = mode(dev_place)) %>%
  ungroup()

filled_data <- filled_data %>%
  left_join(missing_dev, by = "genus") %>%
  mutate(dev_place = coalesce(dev_place.x, dev_place.y)) %>%
  dplyr::select(-dev_place.x, -dev_place.y)


# Longevity Wild
missing_long <- species() %>%
  filter(SpecCode %in% fish_genera$spec_code) %>%
  dplyr::select(SpecCode, LongevityWild) %>%
  janitor::clean_names()

missing_long <- left_join(fish_genera, missing_long)

missing_long <- missing_long %>%
  mutate(longevity_wild = as.numeric(longevity_wild)) %>%
  na.omit() %>%
  group_by(genus) %>%
  summarise(longevity_wild = mean(longevity_wild)) %>%
  ungroup()

filled_data <- filled_data %>%
  left_join(missing_long, by = "genus") %>%
  mutate(longevity_wild = coalesce(longevity_wild.x, longevity_wild.y)) %>%
  dplyr::select(-longevity_wild.x, -longevity_wild.y)


# Preferred Temp
missing_temp <- stocks() %>%
  filter(SpecCode %in% fish_genera$spec_code) %>%
  dplyr::select(SpecCode, TempPreferred) %>%
  janitor::clean_names()

missing_temp <- left_join(fish_genera, missing_temp)

missing_temp <- missing_temp %>%
  mutate(temp_preferred = as.numeric(temp_preferred)) %>%
  na.omit() %>%
  group_by(genus) %>%
  summarise(temp_preferred = mean(temp_preferred)) %>%
  ungroup()

filled_data <- filled_data %>%
  left_join(missing_temp, by = "genus") %>%
  mutate(temp_preferred = coalesce(temp_preferred.x, temp_preferred.y)) %>%
  dplyr::select(-temp_preferred.x, -temp_preferred.y)


# Fecundity Mean
missing_fmean <- fecundity() %>%
  filter(SpecCode %in% fish_genera$spec_code) %>%
  dplyr::select(SpecCode, FecundityMean) %>%
  janitor::clean_names()

missing_fmean <- left_join(fish_genera, missing_fmean)

missing_fmean <- missing_fmean %>%
  mutate(fecundity_mean = as.numeric(fecundity_mean)) %>%
  na.omit() %>%
  group_by(genus) %>%
  summarise(fecundity_mean = mean(fecundity_mean)) %>%
  ungroup()

filled_data <- filled_data %>%
  left_join(missing_fmean, by = "genus") %>%
  mutate(fecundity_mean = coalesce(fecundity_mean.x, fecundity_mean.y)) %>%
  dplyr::select(-fecundity_mean.x, -fecundity_mean.y)


# Oxygen Consumption
missing_ox <- oxygen() %>%
  filter(SpecCode %in% fish_genera$spec_code) %>%
  dplyr::select(SpecCode, OxygenCons) %>%
  janitor::clean_names()

missing_ox <- left_join(fish_genera, missing_ox)

missing_ox <- missing_ox %>%
  mutate(oxygen_cons = as.numeric(oxygen_cons)) %>%
  na.omit() %>%
  group_by(genus) %>%
  summarise(oxygen_cons = mean(oxygen_cons)) %>%
  ungroup()

filled_data <- filled_data %>%
  left_join(missing_ox, by = "genus") %>%
  mutate(oxygen_cons = coalesce(oxygen_cons.x, oxygen_cons.y)) %>%
  dplyr::select(-oxygen_cons.x, -oxygen_cons.y)


# Temp Range
missing_range <- stocks() %>%
  filter(SpecCode %in% fish_genera$spec_code) %>%
  dplyr::select(SpecCode, TempMin, TempMax) %>%
  mutate(temp_range = TempMax - TempMin) %>%
  janitor::clean_names()

missing_range <- left_join(fish_genera, missing_range)

missing_range <- missing_range %>%
  mutate(temp_range = as.numeric(temp_range)) %>%
  na.omit() %>%
  group_by(genus) %>%
  summarise(temp_range = mean(temp_range)) %>%
  ungroup()

filled_data <- filled_data %>%
  left_join(missing_range, by = "genus") %>%
  mutate(temp_range = coalesce(temp_range.x, temp_range.y)) %>%
  dplyr::select(-temp_range.x, -temp_range.y)
```

### Write new csv including genus filled variables

```{r}
# write_csv(filled_data, here::here("01_data", "02_processed_data", "filled_data.csv"))
```

#Asses missing data after genus fills

```{r}
missing_filled <- miss_var_summary(filled_data)

# New missing plot
missing_filled_data <- filled_data %>%
  dplyr::select(
    oxygen_cons, temp_range, fecundity_mean, basin,
    longevity_wild, temp_preferred, iucn_category, circadian
  )

missing_filled_fig <- gg_miss_var(missing_filled_data) + # figure showing the missing data
  theme_bw()
missing_filled_fig

# ggsave(missing_filled_fig, file = paste0("missing_filled_fig.png"), path = here::here("04_figs", "missing_data"))
```

### Fill in missing data from family averages

```{r}
# replace numeric NAs with mean of family, categorical with mode of family

fish_fam <- load_taxa() %>%
  filter(Family %in% data$family) %>%
  dplyr::select(SpecCode, Family) %>%
  janitor::clean_names()

# Longevity Wild
missing_long2 <- species() %>%
  filter(SpecCode %in% fish_fam$spec_code) %>%
  dplyr::select(SpecCode, LongevityWild) %>%
  janitor::clean_names()

missing_long2 <- left_join(fish_fam, missing_long2)

missing_long2 <- missing_long2 %>%
  mutate(longevity_wild = as.numeric(longevity_wild)) %>%
  na.omit() %>%
  group_by(family) %>%
  summarise(longevity_wild = mean(longevity_wild)) %>%
  ungroup()

filled_data2 <- filled_data

filled_data2 <- filled_data2 %>%
  left_join(missing_long2, by = "family") %>%
  mutate(longevity_wild = coalesce(longevity_wild.x, longevity_wild.y)) %>%
  dplyr::select(-longevity_wild.x, -longevity_wild.y)


# Preferred Temp
missing_temp2 <- stocks() %>%
  filter(SpecCode %in% fish_fam$spec_code) %>%
  dplyr::select(SpecCode, TempPreferred) %>%
  filter(SpecCode != 67902) %>%
  janitor::clean_names()

missing_temp2 <- left_join(fish_fam, missing_temp2)

missing_temp2 <- missing_temp2 %>%
  mutate(temp_preferred = as.numeric(temp_preferred)) %>%
  na.omit() %>%
  group_by(family) %>%
  summarise(temp_preferred = mean(temp_preferred)) %>%
  ungroup()

filled_data2 <- filled_data2 %>%
  left_join(missing_temp2, by = "family") %>%
  mutate(temp_preferred = coalesce(temp_preferred.x, temp_preferred.y)) %>%
  dplyr::select(-temp_preferred.x, -temp_preferred.y)


# Fecundity Mean
missing_fmean2 <- fecundity() %>%
  filter(SpecCode %in% fish_fam$spec_code) %>%
  dplyr::select(SpecCode, FecundityMean) %>%
  janitor::clean_names()

missing_fmean2 <- left_join(fish_fam, missing_fmean2)

missing_fmean2 <- missing_fmean2 %>%
  mutate(fecundity_mean = as.numeric(fecundity_mean)) %>%
  na.omit() %>%
  group_by(family) %>%
  summarise(fecundity_mean = mean(fecundity_mean)) %>%
  ungroup()

filled_data2 <- filled_data2 %>%
  left_join(missing_fmean2, by = "family") %>%
  mutate(fecundity_mean = coalesce(fecundity_mean.x, fecundity_mean.y)) %>%
  dplyr::select(-fecundity_mean.x, -fecundity_mean.y)


# Oxygen Consumption
missing_ox2 <- oxygen() %>%
  filter(SpecCode %in% fish_fam$spec_code) %>%
  dplyr::select(SpecCode, OxygenCons) %>%
  janitor::clean_names()

missing_ox2 <- left_join(fish_fam, missing_ox2)

missing_ox2 <- missing_ox2 %>%
  mutate(oxygen_cons = as.numeric(oxygen_cons)) %>%
  na.omit() %>%
  group_by(family) %>%
  summarise(oxygen_cons = mean(oxygen_cons)) %>%
  ungroup()

filled_data2 <- filled_data2 %>%
  left_join(missing_ox2, by = "family") %>%
  mutate(oxygen_cons = coalesce(oxygen_cons.x, oxygen_cons.y)) %>%
  dplyr::select(-oxygen_cons.x, -oxygen_cons.y)


# Temp Range
missing_range2 <- stocks() %>%
  filter(SpecCode %in% fish_fam$spec_code) %>%
  dplyr::select(SpecCode, TempMin, TempMax) %>%
  mutate(temp_range = TempMax - TempMin) %>%
  janitor::clean_names()

missing_range2 <- left_join(fish_fam, missing_range2)

missing_range2 <- missing_range2 %>%
  mutate(temp_range = as.numeric(temp_range)) %>%
  na.omit() %>%
  group_by(family) %>%
  summarise(temp_range = mean(temp_range)) %>%
  ungroup()

filled_data2 <- filled_data2 %>%
  left_join(missing_range2, by = "family") %>%
  mutate(temp_range = coalesce(temp_range.x, temp_range.y)) %>%
  dplyr::select(-temp_range.x, -temp_range.y)
```

### Write new csv including family filled variables

```{r}
# write_csv(filled_data2, here::here("01_data", "02_processed_data", "filled_data2.csv"))
```

#Assess missing data after family fills

```{r}
missing_filled2 <- miss_var_summary(filled_data2)

# New missing plot
missing_filled_data2 <- filled_data2 %>%
  dplyr::select(
    oxygen_cons, temp_range, fecundity_mean, basin,
    longevity_wild, temp_preferred, iucn_category, circadian
  )

missing_filled_fig2 <- gg_miss_var(missing_filled_data2) + # figure showing the missing data
  theme_bw()
missing_filled_fig2

# ggsave(missing_filled_fig2, file = paste0("missing_filled_fig2.png"), path = here::here("04_figs", "missing_data"))
```


### ANOVA/Kruskal-Wallis

```{r}
# FOR CONTINOUS

# check for outliers
filled_data2 %>%
  mutate(class2 = as.factor(class2)) %>%
  group_by(class2) %>%
  identify_outliers(length) %>%
  ungroup()

# Build the linear model
model <- aov(length ~ class2, data = filled_data2)
# Create a QQ plot of residuals
plot(model)
# not normal

# run Kruskal-wallis test
kruskal.test(length ~ class2, data = filled_data2)
# chi-squared = 20.152, df = 6, p-value = 0.002602

dunnTest(length ~ class2, data = filled_data2, method = "bh")
```

```{r}
# FOR CATEGORICAL

chisq.test(filled_data2$class2, filled_data2$demers_pelag)

contingency_table <- table(filled_data2$class2, filled_data2$demers_pelag)
contingency_table

chisq.posthoc.test(contingency_table, method = "bonferroni")
```



### Look at correlation

```{r}
# for original data
corr <- data %>%
  dplyr::select(where(is.numeric))

cor_mat <- round(cor(corr, use = "complete.obs"), 2)
cor_mat

# oxygen_cons, temp_preferred, temp_range, and sp_richness all VERY highly correlated with lots of others?
# length and kfin 100% inverse relationship?
# temp_range and r_fin 100% inverse relationship?
# fecundity, longevity, r_fin
# diet_troph3 and fecundity


# for filled data
corr_filled <- filled_data %>%
  dplyr::select(where(is.numeric))

cor_mat_filled <- round(cor(corr_filled, use = "complete.obs"), 2)
cor_mat_filled

# temp_preferred, kfin, diet_troph3
# temp_range and oxygen_cons
# fecundity, longevity, r_fin
# sp_richness, temp_preferred, length!, diet_troph3!
```


### Process Geographic Info DO NOT RUN 

```{r}
# eco <- ecosystem() %>%
#   filter(SpecCode %in% fish$spec_code) %>%
#   dplyr::select(
#     SpecCode, Climate, NorthernLat, NrangeNS, SouthernLat, SrangeNS,
#     WesternLat, WrangeEW, EasternLat, ErangeEW
#   ) %>%
#   janitor::clean_names() %>%
#   na.omit() %>%
#   mutate(climate = tolower(climate))
#
# eco <- eco[!duplicated(eco$spec_code), ]
#
# eco <- within(eco, {
#   northern_lat <- ifelse(nrange_ns == "N", northern_lat, -northern_lat)
#   southern_lat <- ifelse(srange_ns == "N", southern_lat, -southern_lat)
#   western_lat <- ifelse(wrange_ew == "E", western_lat, -western_lat)
#   eastern_lat <- ifelse(erange_ew == "E", eastern_lat, -eastern_lat)
# }) %>%
#   dplyr::select(-nrange_ns, -srange_ns, -wrange_ew, -erange_ew)
#
# eco_sf = data.frame()
#
# for(i in 1:nrow(eco)) {
#   e = expand.grid(eco$southern_lat[i]:eco$northern_lat[i],
#                   eco$western_lat[i]: eco$eastern_lat[i]) %>%
#     rename(lon = Var1, lat = Var2) %>%
#     mutate(spec_code = eco$spec_code[i])
#
#   eco_sf = rbind(eco_sf, e)
# }
#
# coordinates(eco_sf) <- ~lat+lon #assign which rows are coordinates
# proj4string(eco_sf) <- CRS("+proj=longlat +datum=WGS84") #projection (a spatial thing)
# eco_sf = st_as_sf(eco_sf, coords = 3:4) #create a spatial object

# st_write(eco_sf, here::here("01_data", "02_processed_data", "distribution_points.shp"))

# read in shapefiles for oceans/points
# indian = st_read(here::here("01_data" ,"01_raw_data", "indian.shp"))
# pacific = st_read(here::here("01_data" ,"01_raw_data", "pacific.shp"))
# atlantic = st_read(here::here("01_data" ,"01_raw_data", "atlantic.shp"))
# artic = st_read(here::here("01_data" ,"01_raw_data", "artic.shp"))
# antartic = st_read(here::here("01_data" ,"01_raw_data", "antartic.shp"))
# eco_sf = st_read(here::here("01_data" ,"02_processed_data", "distribution_points.shp"))

# get the intersection of the ocean with the species points
# indian_points = st_intersection(indian, eco_sf) %>%
#   mutate(ocean = "indian") %>%
#   mutate(basin = "indian") %>%
#   select(geometry, ocean, basin)
#
# st_write(indian_points, here::here("01_data", "02_processed_data", "indian_points.shp"))

# artic_points <- st_intersection(artic, eco_sf) %>%
#   mutate(ocean = "artic") %>%
#   mutate(basin = "artic") %>%
#   select(geometry, ocean, basin)
# antartic_points <- st_intersection(antartic, eco_sf) %>%
#   mutate(ocean = "antartic") %>%
#   mutate(basin = "antartic") %>%
#   select(geometry, ocean, basin)
# pacific_points_east <- st_intersection(pacific[4, ], eco_sf) %>%
#   mutate(ocean = "pacific") %>%
#   mutate(basin = "east") %>%
#   select(geometry, ocean, basin)
# pacific_points_west <- st_intersection(pacific[1:3, ], eco_sf) %>%
#   mutate(ocean = "pacific") %>%
#   mutate(basin = "west") %>%
#   select(geometry, ocean, basin)
# atlantic_points_east <- st_intersection(atlantic[2, ], eco_sf) %>%
#   mutate(ocean = "atlantic") %>%
#   mutate(basin = "east") %>%
#   select(geometry, ocean, basin)
# atlantic_points_west <- st_intersection(atlantic[1, ], eco_sf) %>%
#   mutate(ocean = "atlantic") %>%
#   mutate(basin = "west") %>%
#   select(geometry, ocean, basin)
# artic_points <- st_intersection(artic, eco_sf) %>%
#   mutate(ocean = "atlantic") %>%
#   mutate(basin = "west") %>%
#   select(geometry, ocean, basin)
# antartic_points <- st_intersection(antartic, eco_sf) %>%
#   mutate(ocean = "atlantic") %>%
#   mutate(basin = "west") %>%
#   select(geometry, ocean, basin)
#
# points <- list(indian_points, pacific_points_east, pacific_points_west, atlantic_points_east, atlantic_points_west) %>%
#   reduce(rbind) # merges the datasets together
#
# eco <- st_join(eco_sf, points) %>%
#   as.data.frame() %>%
#   dplyr::select(-geometry) %>%
#   distinct() %>%
#   group_by(spec_code) %>%
#   summarise(
#     ocean = paste(sort(unique(ocean)), collapse = ", "),
#     basin = paste(sort(unique(basin)), collapse = ", ")
#   ) %>%
#   distinct()
#
# write_csv(eco, here::here("01_data", "02_processed_data", "ocean_basin.csv"))
```




### Old

```{r}
# rep <- reproduction() %>%
#   filter(SpecCode %in% fish$spec_code) %>%
#   dplyr::select(SpecCode, RepGuild2, Spawning) %>%
#   janitor::clean_names()
#
# fish <- left_join(fish, rep)
#
#
# spawn <- spawning() %>%
#   filter(SpecCode %in% fish$spec_code) %>%
#   dplyr::select(SpecCode, SpawningGround) %>%
#   janitor::clean_names() %>%
#   na.omit()
#
# spawn <- spawn[!duplicated(spawn$spec_code), ]
#
# fish <- left_join(fish, spawn)
```

```{r}
# IUCN Category - DO NOT IMPUTE THIS

# missing_iucn <- stocks() %>%
#   filter(SpecCode %in% fish_genera$spec_code) %>%
#   dplyr::select(SpecCode, IUCN_Code) %>%
#   janitor::clean_names() %>%
#   mutate_at("iucn_code", str_replace, ".", "")
#
# missing_iucn$iucn_code <- gsub("[.]","", missing_iucn$iucn_code)
#
#
# missing_iucn <- left_join(fish_genera, missing_iucn)
#
# missing_iucn <- missing_iucn %>%
#   mutate(iucn_code = as.factor(iucn_code)) %>%
#   group_by(genus) %>%
#   summarise(iucn_category = mode(iucn_code)) %>%
#   ungroup()
#
# filled_data <- filled_data %>%
#         left_join(missing_iucn, by = "genus") %>%
#         mutate(iucn_category = coalesce(iucn_category.x, iucn_category.y)) %>%
#         dplyr::select(-iucn_category.x, -iucn_category.y)


# # Reproduction Guild and Spawning - DO NOT NEED
#
# missing_rep <- reproduction() %>%
#   filter(SpecCode %in% fish_genera$spec_code) %>%
#   dplyr::select(SpecCode, RepGuild2, Spawning) %>%
#   janitor::clean_names()
#
# missing_rep <- left_join(fish_genera, missing_rep)
#
#
# missing_rep <- missing_rep %>%
#   mutate(rep_guild2 = as.factor(rep_guild2), spawning = as.factor(spawning)) %>%
#   group_by(genus) %>%
#   summarise(rep_guild2 = mode(rep_guild2), spawning = mode(spawning)) %>%
#   ungroup()
#
# filled_data <- filled_data %>%
#         left_join(missing_rep, by = "genus") %>%
#         mutate(rep_guild2 = coalesce(rep_guild2.x, rep_guild2.y),
#                spawning = coalesce(spawning.x, spawning.y)) %>%
#         dplyr::select(-rep_guild2.x, -rep_guild2.y, -spawning.x, -spawning.y)
#
#
# # Spawning Ground - DO NOT NEED
#
# missing_spawn <- spawning() %>%
#   filter(SpecCode %in% fish_genera$spec_code) %>%
#   dplyr::select(SpecCode, SpawningGround) %>%
#   janitor::clean_names()
#
# missing_spawn <- left_join(fish_genera, missing_spawn)
#
# missing_spawn <- missing_spawn %>%
#   mutate(spawning_ground = as.factor(spawning_ground)) %>%
#   group_by(genus) %>%
#   summarise(spawning_ground = mode(spawning_ground)) %>%
#   ungroup()
#
# filled_data <- filled_data %>%
#         left_join(missing_spawn, by = "genus") %>%
#         mutate(spawning_ground = coalesce(spawning_ground.x, spawning_ground.y)) %>%
#         dplyr::select(-spawning_ground.x, -spawning_ground.y)
#
```



```{r}
# # the package "sbha/dfnames" doesn't work with newest version of r, so here is their code (edited):
#
# to_snake_case <- function(names){
#   x <- trimws(names)
#   x <- gsub("([a-z])([A-Z])", "\\1_\\2", x)
#   x <- gsub("[[:punct:] ]", "_", x)
#   x <- gsub("_+", "_", x)
#   x <- gsub("^_|_$", "", x)
#   #x <- make.unique(x, sep = "_")
#   x <- tolower(x)
#   x
# }
```

```{r}
# create a function to find the mode of a column

# calc_mode <- function(x){
#
#   distinct_values <- unique(x) # list the unique values
#
#   distinct_tabulate <- tabulate(match(x, distinct_values)) # count the occurrence of each
#
#   distinct_values[which.max(distinct_tabulate)] # return value with highest occurrence
# }


# not like this

# filled_data <- data %>%
#   mutate_at(vars(temp_preferred, longevity_wild, fecundity_max, fecundity_mean,
#                  temp_range, temp_cons, oxygen_cons),
#             ~replace_na(.,mean(., na.rm = TRUE))) %>%
#   mutate(food_i = if_else(is.na(food_i), calc_mode(food_i), food_i)) %>%
#   mutate(iucn_category = if_else(is.na(iucn_category), calc_mode(iucn_category), iucn_category)) %>%
#   mutate(rep_guild2 = if_else(is.na(rep_guild2), calc_mode(rep_guild2), rep_guild2)) %>%
#   mutate(spawning = if_else(is.na(spawning), calc_mode(spawning), spawning)) %>%
#   mutate(spawning_ground = if_else(is.na(spawning_ground),
#                                    calc_mode(spawning_ground), spawning_ground)) %>%
#   mutate(dev_place = if_else(is.na(dev_place), calc_mode(dev_place), dev_place))
```


```{r}
# # get location data (lat and long)
# coords <- stocks() %>%  # load stocks info, then
#   filter(SpecCode %in% fish$SpecCode) %>%  # filter rows by specCodes in fish, then
#   dplyr::select(SpecCode, Northernmost, NorthSouthN, Southermost, NorthSouthS, Westernmost,
#            WestEastW, Easternmost, WestEastE) # dplyr::select columns
#
# coords <- na.omit(coords) # remove NA values
#
# # not sure if I need to make everything uppercase?
#
# coords <- data.frame(lapply(coords, function(v) {
#   if (is.character(v)) return(toupper(v))
#   else return(v)
# }))
#
# # delete duplicate spec_codes (there are only 5)
#
# coords_clean <- coords[!duplicated(coords$SpecCode), ]
#
# # add coords to fish because they share a column
# fish <- left_join(fish, coords_clean)
```

```{r}
# collect maturity variables

# matur <- maturity() %>%
#   filter(SpecCode %in% fish$spec_code) %>%
#   dplyr::select(SpecCode, AgeMatMin, AgeMatMin2) %>%
#   janitor::clean_names() %>%
#   na.omit()
#
# matur <- matur %>%  # average the values for a given spec code
#   group_by(spec_code) %>%
#   summarise(age_mat_min = mean(age_mat_min), age_mat_min2 = mean(age_mat_min2)) %>%
#   ungroup()
#
# fish <- left_join(fish, matur)
```

```{r}
#
# # Only 14 species with schooling behavior listed:
#
# eco <- ecology() %>%
#   filter(SpecCode %in% fish$spec_code) %>%
#   dplyr::select(SpecCode, SchoolingFrequency, SchoolingLifestage) %>%
#   janitor::clean_names()
```

```{r}
# can I average the lat/long values and delete the duplicated rows? <--------------- NO. bc this messes with the E/W delineation

# mean_stocks <- stocks %>%
# group_by(SpecCode) %>%
# summarise(Northernmost = mean(Northernmost), NorthSouthN = NorthSouthN, Southernmost =
# mean(Southermost),NorthSouthS = NorthSouthS, Westernmost = mean(Westernmost), WestEastW =
# WestEastW, Easternmost = mean(Easternmost), WestEastE = WestEastE) %>%
# ungroup()
```

```{r}
# created a dataframe with 3 fewer rows?

# order(data$species) # order the dataframes by species to look for missing species names
# order(fish$Species)
# data$species[!(data$species %in% fish$Species)] # find the species in data that are not included in fish

# 3 species not included in fish: Limanda ferruginea, Oblada melanura, Pennahia anea

# Myzopsetta ferruginea for Limanda ferruginea, Oblada melanurus for Oblada melanura, Pennahia aneas for Pennahia anea
```

```{r}
# eco2 <- eco %>%
#   dplyr::select(-nrange_ns, -srange_ns, -wrange_ew, -erange_ew)
#
# eco2 <- eco2 %>%
#   mutate(
#     northern_lat = as.numeric(northern_lat),
#     southern_lat = as.numeric(southern_lat),
#     western_lat = as.numeric(western_lat),
#     eastern_lat = as.numeric(eastern_lat)
#   ) %>%
#   mutate(pacific = case_when(
#     condition ~ "pacifc",
#     TRUE ~ NA
#   )) %>%
#     mutate(atlantic  = case_when(
#     condition ~ "atlantic",
#     TRUE ~ NA
#   )) %>%
#     mutate(indian  = case_when(
#     condition ~ "indian",
#     TRUE ~ NA
#   )) %>%
#   mutate(ocean = paste0(pacific, atlantic, indian)) %>%
#   mutate(basin = case_when(
#     ocean == "Pacific" & condition ~ "East",
#     ocean == "Pacific" & condition ~ "West",
#     ocean == "Atlantic" & condition ~ "East",
#     ocean == "Atlantic" & condition ~ "West",
#     ocean == "Indian" ~ "Indian",
#     TRUE ~ "Multiple"
#   ))
#
# # indian ocean
# # pacific ocean
# # atlantic ocean
#
# # eastern Atlantic
# # western atlantic
# # eastern pacific
# # western pacific
#
# eastern_lat %in% c(x:y, a:b) & western_lat %in% c(x:y) | eastern_lat %in% c(x:y, a:b) & western_lat %in% c(x:y)
#
#
# #     northern_lat <= 65  & southern_lat >= -60 & western_lat >= -179  & eastern_lat <= -75  ~ "east pacific",
# #     northern_lat <= 65  & southern_lat >= -60 & western_lat >= 120  & eastern_lat <= 180  ~ "west pacific",
# #     northern_lat <= 65  & southern_lat >= -60 & western_lat >= -75  & eastern_lat <= -30  ~ "west atlantic",
# #
# #   mutate(ocean = case_when(
# #     northern_lat <= 65  & southern_lat >= 0 & western_lat >= -175  & eastern_lat <= -70  ~ "northeast pacific",
# #     northern_lat <= 65  & southern_lat >= 0 & western_lat >= 120  & eastern_lat <= -175  ~ "northwest pacific",
# #     northern_lat <= 65  & southern_lat >= 0 & western_lat <= -175  & eastern_lat <= -175  ~ "northwest pacific",
# #     northern_lat <= 65  & southern_lat >= 0 & western_lat >= 120  & eastern_lat >= 120  ~ "northwest pacific",
# #     northern_lat <= 0  & southern_lat >= -60 & western_lat >= -175  & eastern_lat <= -70  ~ "southeast pacific",
# #     northern_lat <= 0 & southern_lat >= -60 & western_lat >= 120 & eastern_lat <= -175 ~ "southwest pacific",
# #     northern_lat <= 25 & southern_lat >= -40 & western_lat >= 20 & eastern_lat <= 100 ~ "indian",
# #     northern_lat <= 25 & southern_lat >= -25 & western_lat >= 100 & eastern_lat <= 120 ~ "indo-pacific",
# #     northern_lat <= 65 & southern_lat >= 0 & western_lat >= -45 & eastern_lat <= 0 ~ "northeast atlantic",
# #     northern_lat <= 65 & southern_lat >= 0 & western_lat >= -80 & eastern_lat <= -45 ~ "northwest atlantic",
# #     northern_lat <= 0 & southern_lat >= -60 & western_lat >= -20 & eastern_lat <= 20 ~ "southeast atlantic",
# #     northern_lat <= 0 & southern_lat >= -60 & western_lat >= -70 & eastern_lat <= -20 ~ "southwest atlantic",
# #   )
# # )
#
# # northeast pacific: -175ºW to -100ºW, 65ºN to 0ºN
# # northwest pacific: 120ºE to -175ºW, 65ºN to 0ºN
# # southeast pacific: -175ºW to -70ºW, 0ºN to -60ºS
# # southwest pacific: 120ºE to -175ºW, 0ºN to -60ºS
# #
# # indian: 20ºE to 100ºE, 25ºN to -40ºS
# #
# # indo-pacfic? 100ºE to 120ºE, 25ºN to -25ºS
# #
# # northeast atlantic: -45ºW to 0ºW, 65ºN to 0ºN
# # northwest atlantic: -80ºW to -45ºW, 65ºN to 0ºN
# # southeast atlantic: -20ºW to 20ºE, 0ºN to -60ºS
# # southwest atlantic: -70ºW to -20ºW, 0ºN to -60ºS
```

```{r}
# range <- ocean_data %>%
#   mutate(ocean_basin = case_when(
#     !is.na(basin) ~ paste(basin, ocean),
#     is.na(basin) ~ ocean
#   )) %>%
#   group_by(species) %>%
#   summarise(
#     ocean = paste(sort(unique(ocean)), collapse = ", "),
#     basin = paste(sort(unique(basin)), collapse = ", "),
#     ocean_basin = paste(sort(unique(ocean_basin)), collapse = ", ")
#   ) %>%
#   ungroup() %>%
#   mutate_all(na_if, "")
#
# fish <- left_join(fish, range)
```
